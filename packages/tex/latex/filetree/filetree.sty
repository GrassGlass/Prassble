\NeedsTeXFormat{LaTeX2e}
\ProvidesExplPackage {filetree} {2025-10-16} {1.0} {Automatic generation of forest file trees with bash (tree + sed).}

% Source : https://tex.stackexchange.com/a/405253/383565

% Packages
\RequirePackage[edges]{forest}

% Colours
\definecolor{g__filetree_folderbg_colors}{RGB}{124,166,198}
\definecolor{g__filetree_folderborder_colors}{RGB}{110,144,169}

% Variables
  \tl_new:N \g__filetree_font_tl
    \tl_set:Nn \g__filetree_font_tl {\ttfamily}

  % Integers
  \int_new:N \g__filetree_current_tree_number_int

  % Dimensions
  \dim_new:N \g__filetree_pic_size_dim
    \dim_set:Nn \g__filetree_pic_size_dim {4pt}

  % \cs_new:Npn \__filetree_paths_and_options_core_processing:nn #1#2 {
  %   % Step the counter for the file tree number
  %   \int_gincr:N \g__filetree_current_tree_number_int
  %   % Default output location
  %   \str_gset:Ne \g__filetree_Output_To_str {FileTrees/tree_\int_use:N \g__filetree_current_tree_number_int.tex}

  %   \keys_set:nn { filetree } { #1 }
  %   % Final flag processing before parsing to textree
  %   %* Even though we use the e-type argument later, it must be used now also.
  %       % -i
  %       \str_if_empty:NF \g__filetree_i_str {
  %           \str_set:Ne \g__filetree_final_i_str { -i~"\g__filetree_i_str" }
  %       }
  %       % -I
  %       \bool_if:NT \g__filetree_I_bool {
  %           \str_set:Ne \g__filetree_final_I_str { -I~"\g__filetree_I_only_str"}
  %       }
  %       % -O
  %       \str_if_empty:NF \g__filetree_Output_To_str {
  %           \str_set:Ne \g__filetree_final_Output_To_str { -O~"\g__filetree_Output_To_str" }
  %       }
        
  %   % File path parsed to textree
  %       \str_set:Ne \g__filetree_file_path_str {
  %         \str_if_empty:nTF { #2 }
  %           { "./" }
  %           { "#2" }
  %       }

  %   % Flags and argument passed to textree
  %     \str_set:Ne \g__filetree_sys_shell_now_str {
  %     % Execute the bash script textree
  %         textree
  %     \c_space_tl
  %     % -i flag
  %         \g__filetree_final_i_str
  %     \c_space_tl
  %     % -I flag (activated only if the string is nonempty)
  %         \g__filetree_final_I_str
  %     \c_space_tl
  %     % -O flag
  %         \g__filetree_final_Output_To_str
  %     \c_space_tl
  %     % File path parsed to textree (the argument of textree)
  %         \g__filetree_file_path_str
  %     }
  %     \bool_if:NT \g__filetree_debug_bool {
  %       \begin{center}
  %         \fbox{
  %           \begin{minipage}{\linewidth}
  %             String~passed~to~\texttt{textree}:\par
  %             \texttt{\str_use:N \g__filetree_sys_shell_now_str}
  %           \end{minipage}
  %         }
  %       \end{center}
  %     }
  % }

  % % Messages
  % \msg_new:nnn {filetree} {shell_escape_is_disabled} {Unrestricted~shell~escape~is~disabled.~Using~cached~files~\msg_line_context:,~if~they~exist.}

% Keys
\tikzset{
  ,folder/.pic={
    \filldraw [
        ,draw           = g__filetree_folderborder_colors
        ,top~color      = g__filetree_folderbg_colors!50
        ,bottom~color   = g__filetree_folderbg_colors
        ,sharp~corners
    ] 
    (-1.05*\g__filetree_pic_size_dim,0.2\g__filetree_pic_size_dim+5pt) rectangle ++(.75*\g__filetree_pic_size_dim,-0.2\g__filetree_pic_size_dim-5pt);

    \filldraw [
        ,draw           = g__filetree_folderborder_colors
        ,top~color      = g__filetree_folderbg_colors!50
        ,bottom~color   = g__filetree_folderbg_colors
        ,sharp~corners
    ] 
    (-1.15*\g__filetree_pic_size_dim,-\g__filetree_pic_size_dim) rectangle (1.15*\g__filetree_pic_size_dim,\g__filetree_pic_size_dim);
  }
  ,file/.pic={
    \filldraw [
        ,draw           = g__filetree_folderborder_colors
        ,top~color      = g__filetree_folderbg_colors!5
        ,bottom~color   = g__filetree_folderbg_colors!10
        ,sharp~corners
    ] 
    (-\g__filetree_pic_size_dim,.4*\g__filetree_pic_size_dim+5pt) coordinate (a) |- (\g__filetree_pic_size_dim,-1.2*\g__filetree_pic_size_dim) coordinate (b) -- ++(0,1.6*\g__filetree_pic_size_dim) coordinate (c) -- ++(-4pt,5pt) coordinate (d) -- cycle (d) |- (c) ;
  }
}
\forestset{
  ,declare~autowrapped~toks = {filetree_pic_me_toks}{}
  ,declare~boolean~register = {filetree_pic_root_bool}
  ,filetree_pic_root_bool                 = 0
  ,filetree_pic_dir_tree/.style={
    ,for~tree={
      ,folder
      ,font     = \g__filetree_font_tl
      ,grow'    = 0
      % ,edge = {rounded~corners=5pt}
    }
    ,before~typesetting~nodes = {
      ,for~tree     = {
        ,edge~label+/.option  = {filetree_pic_me_toks},
      }
      ,if~filetree_pic_root_bool  = {
        ,tikz+  = {
          \pic at ([xshift=\g__filetree_pic_size_dim].west) {folder};
        }
        ,align  = {l}
      }{}
    }
  }
  ,filetree_pic_me_set/.code~n~args = { 2 } {
    \forestset{
      #1/.style     = {
        inner~xsep  = 2\g__filetree_pic_size_dim,
        filetree_pic_me_toks      = {pic {#2}},
      }
    }
  }
  ,file~tree/.style = {
    ,filetree_pic_me_set     = {directory}{folder}
    ,filetree_pic_me_set     = {file}{file}
    ,filetree_pic_dir_tree
    ,filetree_pic_root_bool
    ,for~tree={% folder icons by default; override using file for file icons
      ,directory
      ,fit = band
      ,l~sep = 2\g__filetree_pic_size_dim+4mm
    }
  }
}
\makeatletter
\dim_new:N \g_dirtree_dots_radius_dim
\dim_new:N \g_dirtree_dots_length_dim
\dim_set:Nn \g_dirtree_dots_radius_dim {0.5pt}
\dim_set:Nn \g_dirtree_dots_length_dim {5pt}
\forestset{%
  declare~toks={real~siblings}{},
  continue_tikz_vdots/.style = {
    tikz+={
      \coordinate (A') at ($(A\foresteoption{id})+(0,\g_dirtree_dots_radius_dim)$);
      \coordinate (B') at ($(B\foresteoption{id})-(0,\g_dirtree_dots_radius_dim)$);
      \coordinate (C) at ($0.25*($(B')-(A')$)$);
      \fill ($(A')+(C)$) circle (\g_dirtree_dots_radius_dim);
      \fill ($(A')+2*(C)$) circle (\g_dirtree_dots_radius_dim);
      \fill ($(A')+3*(C)$) circle (\g_dirtree_dots_radius_dim);
      % Debugging
        % \draw[blue] ($(A')-(5pt,0)$) -- ($(A')+(5pt,0)$);
        % \draw[red] ($(A')+(C)-(5pt,0)$) -- ($(A')+(C)+(5pt,0)$);
        % \draw[red] ($(A')+2*(C)-(5pt,0)$) -- ($(A')+2*(C)+(5pt,0)$);
        % \draw[red] ($(A')+3*(C)-(5pt,0)$) -- ($(A')+3*(C)+(5pt,0)$);
        % \draw[red] ($(A')+4*(C)-(5pt,0)$) -- ($(A')+4*(C)+(5pt,0)$);
        % \draw[blue] ($(B')-(5pt,0)$) -- ($(B')+(5pt,0)$);                        
    },
  },
  % Old way to ensure s sep and l sep are correct when 'continue' is used
    % continue/.code = {
    %   % WARNING: forest internal macros, this may need fixing if forest's internals change.
    %   \tl_gset_eq:Nc \g__dirtree_old_s_sep_tl {fRsT\forest@cn/s~sep}
    %   \tl_gset_eq:Nc \g__dirtree_old_l_sep_tl {fRsT\forest@cn/l~sep}
    % },
  continue/.append~style={%
    delay={%
      if~n~children=0{%
        before~computing~xy={%
          for~current~and~following~siblings={%
            s'+=-10pt,
          },
        },
        if~n=1{%
          edge~path'={%
            (!u.parent~anchor) ++(\foresteregister{folder~indent},0pt)
            coordinate (a) --
            ($(!u.parent~anchor -| a)!1/3!(.child~anchor -| a)$)
            edge [dotted]  
            ($(!u.parent~anchor -| a)!2/3!(.child~anchor -| a)$)
            ($(!u.parent~anchor -| a)!2/3!(.child~anchor -| a)$)
            |- (.child~anchor)
          },
        }{%
          edge~path'={%
            (!u.parent~anchor |- !p.child~anchor) 
            ++(\foresteregister{folder~indent},0pt)
            coordinate (a) --
            ($(!p.child~anchor -| a)!1/3!(.child~anchor -| a)$)
            edge [dotted]  
            ($(!p.child~anchor -| a)!2/3!(.child~anchor -| a)$)
            ($(!p.child~anchor -| a)!2/3!(.child~anchor -| a)$)
            |- (.child~anchor)
          },
        },
        for~following~siblings={%
          edge~path'={%
            (!u.parent~anchor |- !p.child~anchor) 
            ++(\foresteregister{folder~indent},0pt) |-
            (.child~anchor)
          },
        },
      }{%
        prepend={[\strut,
            delay={%
              do~dynamics,
              temptoksa=,
              for~following~siblings={%
                if~temptoksa={}{}{%
                  temptoksa+={,},
                },
                temptoksa+/.option=name,
              },
              real~siblings/.register=temptoksa,
              folder,
              grow'=0,
              before~computing~xy={%
                l'=0pt,
                s'=-\g_dirtree_dots_length_dim, % length of vdots
              },
              delay~n=2{%
                split~option={real~siblings}{,}{append},
              },
              before~typesetting~nodes={%
                temptoksa/.option=name,
                delay={
                  do~dynamics,
                  % Old way to ensure s sep and l sep are correct when 'continue' is used
                    % s~sep = \g__dirtree_old_s_sep_tl,
                    % l~sep = \g__dirtree_old_l_sep_tl,
                  s~sep/.option=!1.s~sep,
                  l~sep/.option=!1.l~sep,
                  for~children={
                    if~n=1{
                      edge~path'={%
                        (!uu.parent~anchor) ++(\foresteregister{folder~indent},0pt)
                        coordinate (a) --
                        ($($(a)!1/2!(.child~anchor -| a)$)+0.5*(0,\g_dirtree_dots_length_dim)$) coordinate (A\foresteoption{id})        
                        %
                        ($($(a)!1/2!(.child~anchor -| a)$)-0.5*(0,\g_dirtree_dots_length_dim)$) coordinate (B\foresteoption{id}) |-  (.child~anchor)%
                      },
                      continue_tikz_vdots
                    }{
                      edge~path'={%
                        (!uu.parent~anchor) ++(\foresteregister{folder~indent},0pt)
                        coordinate (a) 
                        (a |- !p.child~anchor) |- (.child~anchor)
                      },
                    },
                  },
                },
              },
            },
            no~edge,
        ]},
      },
    },
  },
  to~be~continued/.style={%
    delay={%
      append={[\strut,
        folder,
        grow'=0,
        before~computing~xy={%
          l'=0pt,
          s'=-\g_dirtree_dots_length_dim,
        },
        if~n~children=0{%
          before~drawing~tree={%
            delay={%
              y/.min={>O{y}}{parent,descendants},
            },
          },
        }{},
        edge~path'={%
          (!uu.parent~anchor |- !u.child~anchor) 
          ++(\foresteregister{folder~indent},0pt)
          coordinate (a) --
          (.parent~anchor -| a) coordinate (A\foresteoption{id})
          %
          ([yshift=-\g_dirtree_dots_length_dim]% length of vdots
          A\foresteoption{id}) coordinate (B\foresteoption{id})
        },
        continue_tikz_vdots
      ]},
    },
  },
}
\makeatother

\keys_define:nn {filetree} {
,font           .tl_set:N = \g__filetree_font_tl

,i              .str_set:N = \g__filetree_i_str
    ,ignore         .meta:n   = { i = #1 }


,i+             .code:n   = { \str_put_right:Nn { \g__filetree_i_str } }
    ,ignore-add     .meta:n   = { i+ = #1 }
    ,ignore-also    .meta:n   = { i+ = #1 }


,i-extensions   .code:n   = { 
    \clist_map_inline:nn { #1 } {
    % Make sure each item (file extension) of the user's clist is prepended with a dot (if it isn't already there).
    \str_if_eq:eeTF 
        { \str_item:nn {##1} {1} } 
        { . }
        { 
          \str_if_empty:NF \g__filetree_i_str { 
            \str_put_right:Nn \g__filetree_i_str { | }
           }
          \str_put_right:Ne \g__filetree_i_str { *##1 } 
        }
        { 
          \str_if_empty:NF \g__filetree_i_str {
            \str_put_right:Nn \g__filetree_i_str { | }
          }
          \str_put_right:Ne \g__filetree_i_str { *.##1 } 
        }
    }
}


,i-match-name   .code:n   = {
    \str_put_right:Ne \g__filetree_i_str { \clist_use:nn { #1 } { | } }
}
    ,i-folders      .meta:n   = { i-match-name = #1 }
    ,i-files        .meta:n   = { i-match-name = #1 }


,i-clear        .code:n   = { \str_clear:N \g__filetree_i_str }

,I              .code:n   = {
    \bool_set_true:N \g__filetree_I_bool
    \str_set:Nn \g__filetree_I_only_str {#1}
}
    ,Ignore         .meta:n   = { I = #1 }
    ,Ignore-only    .meta:n   = { I = #1 }
    ,I-only         .meta:n   = { I = #1 }
,I-clear        .code:n   = { \str_clear:N \g__filetree_I_only_str }


,O              .str_set:N   = \g__filetree_Output_To_str
    ,output-to      .meta:n   = { O = #1 }
    ,output-To      .meta:n   = { O = #1 }
    ,Output-to      .meta:n   = { O = #1 }
    ,Output-To      .meta:n   = { O = #1 }

,debug          .bool_set:N   = \g__filetree_debug_bool
,debug          .default:n    = true
  
,Inputify           .code:n   = { \__filetree_Inputify:nn #1 } 

,pathkey        .tl_set:N   = \g__FileTree_pathkey_tl

,forest         .code:n     = { \forestset{ file~tree/.append~style = #1 }}
,for-tree       .tl_set:N   = \g__FileTree_user_appended_for_tree_keys_tl
}

\NewDocumentCommand{\filetree}{ O{} m }{
\group_begin:
  \__filetree_paths_and_options_core_processing:nn { #1 } { #2 }

  \sys_if_shell_unrestricted:TF 
    { \sys_shell_now:e {\g__filetree_sys_shell_now_str} }
    { \msg_note:nn {filetree} {shell_escape_is_disabled} }

  \file_input:V \g__filetree_Output_To_str
\group_end:
}

% Ensure bash script works correctly in PATH (i.e. when it is incorporated into TeXlive)
% sudo cp -s "/workspaces/Prassble/testing/tree/textree" "/usr/local/bin/textree"
% source ~/.bashrc

\file_input_stop: