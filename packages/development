#!/bin/bash
# Run this script to ensure your copy of the LaTeX project Prassble is ready for use/compilation.
# Note! This script should be located in .../packages/development. Don't move it elsewhere!

# Update workspace first
    apt-get -y update && apt-get -y upgrade

# Bash packages to install
    apt install tree

# Get relative paths to work relative to this script's location, rather than the location where the script is invoked from. 
    # Source: https://stackoverflow.com/a/24114056/31298396
    scriptDir=$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")
    cd "$scriptDir" || exit
    # For debugging, we log the pwd.
    pwd

# Function to copy bash script in PATH (i.e. when it is incorporated into TeXlive)
    script_to_path() {
        new_name=${2:-$(basename $1)}
        # Remove the script if it is already present, so we can copy the updated version (if it has been updated, otherwise the same version) 
            rm /usr/local/bin/$new_name
        # Copy with symbolic link
            sudo cp "$1" "/usr/local/bin/$new_name"
        # Magic update thingy
            source ~/.bashrc
    }
    # Scripts to apply the function to
        script_to_path ./tex/latex/filetree/file_tree


# Ensure this directory "packages" is registered under TeXlive  
    texmf_cnf="$(kpsewhich texmf.cnf)"
    # The string to append to texmf.cnf.
        # 1. $SELFAUTOPARENT/../texmf-local --- this is just the default directory.
        # 2. $scriptDir ---- the folder .../Prassble/packages.
        # This order ensures that $scirptDir takes precedence, so if two copies of <package A> is found (one in 1. and the other in 2.), the one in 2. will be used --- such as when we do \usepackage{ <package A> }.
        # When we add a directory $dir to TEXMFLOCAL, all LaTeX packages should be placed under some subdirectory of dir/tex/latex.
        append_texmf_cnf="TEXMFLOCAL = \$SELFAUTOPARENT/../texmf-local,$scriptDir"
    # If $append_texmf_cnf is not found in $texmf_cnf, then append it to the end of $texmf_cnf.
        if ! grep -q "$append_texmf_cnf" "$texmf_cnf"; then
            printf "\n$append_texmf_cnf" >> $texmf_cnf
        fi
    # Update stuff for kpsewhich to function correctly
        texhash