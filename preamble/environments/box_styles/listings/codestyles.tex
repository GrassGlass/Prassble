%% The LaTeX project Prassble
%% codestyles.tex: the tcbkey (pgfkey) that sets the style of the listing boxes (tcblisting/tcbinputlisting options)
%%
%% -------------------------------------------------------------------------------------------
%% Copyright (c) 2025 by Grass (GrassGlass) <shaohong00002 at gmail dot com>
%% -------------------------------------------------------------------------------------------
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `author-maintained'.
%%
%% This work consists of all files listed in README
%%
% User level comparator
    % source: https://tex.stackexchange.com/a/748134/383565
\makeatletter
\ExplSyntaxOn
\cs_set_eq:NN \DimComparenNnT \dim_compare:nNnT
\cs_set_eq:NN \DimComparenNnTF \dim_compare:nNnTF
\cs_set_eq:NN \BoolLazyOrnnT \bool_lazy_or:nnT
\cs_set_eq:NN \BoolLazyOrnnTF \bool_lazy_or:nnTF
\cs_set_eq:NN \TLIfEqeeT \tl_if_eq:eeT

% Colors
\def\ColorCodeBase{Maroon}
\def\ColorCodeColback{\ColorCodeBase!5}
\def\ColorCodeColbacktitle{\ColorCodeBase!5}
\def\ColorCodeTitle{\ColorCodeBase!70!black}
\def\ColorCodeBorderline{\ColorCodeBase}
\def\ColorCodeLineNumber{\ColorCodeBase}
\def\ColorCodeLineNumberBackground{\ColorCodeBase!20}

% Variables
  % Definitions
  \tl_new:N \l__listings_linenos_tl
  \tl_new:N \l__listings_breaklines_tl
  \tl_new:N \l__listings_OTitle_tl
  \bool_new:N \l__listings_autowidth_all_bool
  \bool_new:N \l__listings_autowidth_upper_bool
  % Values
  \tl_set:Nn \l__listings_linenos_tl {linenos}
  \tl_set:Nn \l__listings_breaklines_tl {breaklines}
  \bool_set_false:N \l__listings_autowidth_all_bool
  \bool_set_false:N \l__listings_autowidth_upper_bool

\tcbset{
% expl3 equivalents
    % Help sourced from https://tex.stackexchange.com/a/748130/383565
  ,DimComparenNnT/.code~n~args={4}{\DimComparenNnT{#1}#2{#3}{\pgfkeysalso{#4}}}
  ,DimComparenNnTF/.code~n~args={5}{\DimComparenNnTF{#1}#2{#3}{\pgfkeysalso{#4}}{\pgfkeysalso{#5}}}
  ,BoolLazyOrnnT/.code~n~args={4}{\BoolLazyOrnnT{#1}{#2}{\pgfkeysalso{#3}}}
  ,BoolLazyOrnnTF/.code~n~args={4}{\BoolLazyOrnnTF{#1}{#2}{\pgfkeysalso{#3}}{\pgfkeysalso{#4}}}
  ,TLIfEqeeT/.code~n~args={3}{\TLIfEqeeT{#1}{#2}{\pgfkeysalso{#3}}}
  % ,TLIFEqeeT/.code~n~args={3}{\TLIfEqeeT{#1}{#2}{\pgfkeysalso{#3}}}
% Listing keys
  ,no~number/.code = {\tl_clear:N \l__listings_linenos_tl}
  ,autowidth@core/.code = 
  {
    % Disable breaklines to allow \eqboxwidth{codewidth\arabic{code}} to correctly measure the greatest line width. Enable breaklines if the line width overflows into the margins.
    \dim_compare:nNnTF
      % Relationship to compare 
      {\textwidthoutside} 
      < 
      {\eqboxwidth{codewidth\arabic{code}}+\truelefthspace+\linebreakcorrector}
      % TF code execution
      {\tl_set:Nn \l__listings_breaklines_tl {breaklines}}
      {\tl_clear:N \l__listings_breaklines_tl}
    % autowidth functionality: setting the tcbkey 'text width'
      \dim_compare:nNnF
        % Relationship to compare
        {\textwidthoutside}
         <
        {\eqboxwidth{codewidth\arabic{code}}+\truelefthspace+\linebreakcorrector}
        % F code execution
        {\pgfkeysalso{text~width = \eqboxwidth{codewidth\arabic{code}}}}
  }
  ,autowidth/.is~choice
    ,autowidth/all/.code = {
      \bool_set_true:N \l__listings_autowidth_all_bool
      \pgfkeysalso{autowidth@core}} 
    ,autowidth/upper/.code = {
      \bool_set_true:N \l__listings_autowidth_upper_bool
      \pgfkeysalso{autowidth@core}}
  ,Title/.style = 
  {
    IfBooleanTF = {\l__listings_autowidth_all_bool}
      {
        title   = 
        {
          \sffamily\bfseries\color{\ColorCodeTitle}
            {
              \hspace{-\eqboxwidth{code\arabic{code}}+\titleleft}
              \eqsavebox{\codewidth}[codewidth\arabic{code}]{#1}
              #1
            }
          }
      }
      {
        title = 
        {
          \sffamily\bfseries\color{\ColorCodeTitle}
          {
            \hspace{-\eqboxwidth{code\arabic{code}}+\titleleft}
            #1
          }
        }
      }
  }
    ,Title/.style = 
  {
    IfBooleanTF = {\l__listings_autowidth_all_bool}
      {
        title   = 
        {
          \sffamily\bfseries\color{\ColorCodeTitle}
            {
              \hspace{-\eqboxwidth{code\arabic{code}}+\titleleft}
              \eqsavebox{\codewidth}[codewidth\arabic{code}]{#1}
              #1 \l__listings_OTitle_tl.
            }
          }
      }
      {
        title = 
        {
          \sffamily\bfseries\color{\ColorCodeTitle}
          {
            \hspace{-\eqboxwidth{code\arabic{code}}+\titleleft}
            #1 \l__listings_OTitle_tl.
          }
        }
      }
  }
  ,OTitle/.code = {
    \tl_if_empty:nF {#1} {\tl_set:Nn \l__listings_OTitle_tl {~(#1)}}
  }
  ,vflush/.style = {before~skip = -\vlengthbeforelisting}
  ,vnormal/.style = {before~skip = \vlengthbetweencorrector}
% Base listing style
    % Help sourced from https://tex.stackexchange.com/a/748148/383565
    % codestylebase = { <Unparenthesized Title> }
  ,codestylebase/.style =
  {
    ,left                            = {\truelefthspace}
    ,listing~engine                  = minted
    ,minted~style                    = staroffice
    ,minted~options                  = 
      {
      \l__listings_breaklines_tl,
      autogobble,
      \l__listings_linenos_tl,
      numbersep = \numbersep
      }
    ,listing~only
    ,breakable
    ,enhanced
    ,skin                            = enhanced~jigsaw
    ,boxsep                          = \boxsep
    ,boxrule                         = \boxrule
    ,colback                         = \ColorCodeColback 
    ,Title                           = {#1}
    ,toptitle                        = 2mm
    ,bottomtitle                     = 2mm
    ,colbacktitle                    = \ColorCodeColbacktitle,
    ,borderline~west                 = {\BorderlineWestThickness}{0pt}{\ColorCodeBorderline}
    ,overlay~unbroken                = {
        \begin{tcbclipinterior}
            % Background for the code line numebrs
            \filldraw[\ColorCodeLineNumberBackground] 
            (frame.south~west) --
            (interior.north~west) {[rounded~corners=4] --
            ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0) --
            ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding]frame.south~west)} --
            (frame.south~west);
            % Borderline west of \BorderlineWestThickness thickness
            \fill[\ColorCodeBorderline] (frame.south~west)
            rectangle ([xshift=\BorderlineWestThickness]frame.north~west);
        \end{tcbclipinterior}
    }
    ,overlay~first                   = {
        \begin{tcbclipinterior}
            % Background for the code line numebrs
            \filldraw[\ColorCodeLineNumberBackground] 
            (frame.south~west) --
            (interior.north~west) {[rounded~corners=4] --
            ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0)} --
            ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding]frame.south~west) --
            (frame.south~west);
            % Borderline west of \BorderlineWestThickness thickness
            \fill[\ColorCodeBorderline] (frame.south~west)
            rectangle ([xshift=\BorderlineWestThickness]frame.north~west);
        \end{tcbclipinterior}
    }
    ,overlay~middle                  = {
        \begin{tcbclipinterior}
            % Background for the code line numebrs
            \fill[\ColorCodeLineNumberBackground] (frame.south~west)
            rectangle ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding]frame.north~west);
            % Borderline west of \BorderlineWestThickness thickness
            \fill[\ColorCodeBorderline] (frame.south~west)
            rectangle ([xshift=\BorderlineWestThickness]frame.north~west);
        \end{tcbclipinterior}
    }
    ,overlay~last                    = {
        \begin{tcbclipinterior}
            % Background for the code line numebrs
            \filldraw[\ColorCodeLineNumberBackground] 
            (frame.south~west) --
            (frame.north~west) --
            ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0) {[rounded~corners=4] --
            ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding]frame.south~west)} --
            (frame.south~west);
            % Borderline west of \BorderlineWestThickness thickness
            \fill[\ColorCodeBorderline] (frame.south~west)
            rectangle ([xshift=\BorderlineWestThickness]frame.north~west);
        \end{tcbclipinterior}
    }
  }
% listing environment style
    % Help sourced from https://tex.stackexchange.com/a/748148/383565
    % codestlyenvironment = 
    % #1  { <displayed language name to be converted to minted language>}
    % #2  { <Unparentisized Title> }
  ,codestyleenvironment/.style~2~args =
  {
    ,code = {\DisplayedToPygments{#1}}
    ,minted~language                 = {\pygmentsname}
    ,codestylebase                   = {#2}
  }
% input listing style
    % Help sourced from https://tex.stackexchange.com/a/748148/383565
    % codestyleinput = 
    % #1  { <Listing file> }
    % #2  { <Unparentisized Title> }
  ,codestyleinput/.style~2~args =
  {
    ,listing~file   = {#1}
    ,code           = {\storefileextension{#1}
    \FileExtensionToLanguage{\fileextension}}
    ,minted~language = {\pygmentsname}
    ,codestylebase  = {#2}
  },
}
\ExplSyntaxOff
\makeatother

% Base listing style, continued
\renewcommand{\theFancyVerbLine}{
                \eqmakebox[code\arabic{code}][c]{
                    \textcolor{\ColorCodeLineNumber}{\scriptsize\arabic{FancyVerbLine}}
                }
            }
\renewcommand{\FancyVerbFormatLine}[1]{\eqsavebox{\codewidth}[codewidth\arabic{code}]{#1}#1}

