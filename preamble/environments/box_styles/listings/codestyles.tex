%% The LaTeX project Prassble
%% codestyles.tex: the tcbkey (pgfkey) that sets the style of the listing boxes (tcblisting/tcbinputlisting options)
%%
%% -------------------------------------------------------------------------------------------
%% Copyright (c) 2025 by Grass (GrassGlass) <shaohong00002 at gmail dot com>
%% -------------------------------------------------------------------------------------------
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `author-maintained'.
%%
%% This work consists of all files listed in README
%%
\makeatletter
\ExplSyntaxOn

% Variables
  % Definitions
  \tl_new:N \g__Prassble_before_add_tl
  \tl_new:N \g__Prassble_after_add_tl
  \tl_new:N \g__Prassble_listings_linenos_tl
  \tl_new:N \g__Prassble_listings_breaklines_tl
  \tl_new:N \g__Prassble_listings_minted_add_tl
  \tl_new:N \g__Prassble_listings_Input_prepended_path_or_keyword_tl
  \tl_new:N \inputPath
  \cs_new:Npn \__Prassble_listings_title_contents:n #1 {#1 \g__Prassble_listings_OTitle_tl.}
  \tl_new:N \g__Prassble_listings_OTitle_tl
  \dim_new:N \l__Prassble_listings_autowidth_title_dim
  \dim_new:N \l__Prassble_listings_autowidth_upper_dim
  \dim_new:N \l__Prassble_listings_autowidth_lower_dim
  \dim_new:N \g__Prassble_listings_autowidth@core_measured_text_width_dim
  \dim_new:N \g__Prassble_listings_autowidth@core_measured_width_dim
  \dim_new:N \g__Prassble_listings_autowidth@core_text_width_dim
  \dim_new:N \g__Prassble_listings_autowidth@core_text_width_vs_width_difference_dim 
  \dim_new:N \g__Prassble_listings_autowidth@core_max_tcb_text_width_dim
  \dim_new:N \g__Prassble_listings_Leftupper_dim
  \dim_new:N \g__Prassble_listings_autowidth@core_max_tcb_width_dim
  \dim_new:N \g__Prassble_listings_type_in_thmgroup_inner_left_growth_dim
  \dim_new:N \g__Prassble_listings_type_in_thmgroup_inner_right_growth_dim
  \cs_new:Npn \__tcb_text_width_to_width:n #1
  {
    #1+\g__Prassble_listings_autowidth@core_text_width_vs_width_difference_dim
  }
  \cs_new:Npn \__tcb_width_to_text_width:n #1
  {
    #1-\g__Prassble_listings_autowidth@core_text_width_vs_width_difference_dim
  }
  \cs_new:Npn \__Prassble_listings_autowidth_title:n #1
  {
    \bool_if:NT 
      {\g__Prassble_listings_autowidth_title_bool} 
      {
        \eqsavebox{\codewidth}[codetitlewidth\arabic{code}]
        {
          \__Prassble_listings_title_contents:n {#1}
        }
      }
  }
  \cs_new:Npn \__Prassble_listings_autowidth_lower_savewidth:
  {
    \bool_if:NT \g__Prassble_listings_autowidth_lower_bool
      {
        % varwidth used to make a box of natural width; eqsavebox to save this width
          % \eqsavebox does not allow for line breaks
          % \eqparbox allows for line breaks, but does not play well with \centering & friends
        % The \setbox0 = \hbox trick allows us to obtain the same effect as using \savebox, of not having any effect on the typeset output. 
        \bool_if:NT \g__Prassble_listings_include_codeoutput_bool
          {
            \eqsavebox{\codewidth}[codelowerwidth\arabic{code}]{
              \begin{varwidth}{\g__Prassble_listings_autowidth@core_max_tcb_width_dim}
                \tcbuselistingtext
              \end{varwidth}
            }
          }
        \bool_if:NT \g__Prassble_listings_include_comment_bool
          {
            \eqsavebox{\codewidth}[codelowerwidth\arabic{code}]{
              \begin{varwidth}{\g__Prassble_listings_autowidth@core_max_tcb_width_dim}
                \tcbuselistingcomment
              \end{varwidth}
            }
          }
      }
  }
  \cs_new:Npn \__Prassble_listings_debug_autowidth:
  {
    \bool_if:NT \g__Prassble_listings_debug_autowidth_bool
        { 
          \renewcommand{\labelalignment}{c}
          \begin{enumerate}
            \item \codeinline{TeX}{\arabic{code}}:\ \arabic{code}
            \item \codeinline{TeX}{\eqboxwidth{ⵌ\textlangle tag\textrangleⵌ}}
              \begin{enumerate}
                \item[\underline{\codeinline{TeX}{ⵌ\textlangle tag\textrangleⵌ}}]
                \item[\codeinline{TeX}{codetitlewidth}:] \eqboxwidth{codetitlewidth\arabic{code}}\ \rule{\eqboxwidth{codetitlewidth\arabic{code}}}{1pt}
                \item[\codeinline{TeX}{codeupperwidth}:] \eqboxwidth{codeupperwidth\arabic{code}}\ \rule{\eqboxwidth{codeupperwidth\arabic{code}}}{1pt}
                \item[\codeinline{TeX}{codelowerwidth}:] \eqboxwidth{codelowerewidth\arabic{code}}\ \rule{\eqboxwidth{codelowerwidth\arabic{code}}}{1pt}
              \end{enumerate}
            \item \codeinline{TeX}{\l__Prassble_listings_autowidth_ⵌ\textlangle component\textrangleⵌ_dim}
              \begin{enumerate}
                \item[\underline{\codeinline{TeX}{ⵌ\textlangle component\textrangleⵌ}}]
                \item[\codeinline{TeX}{title}:] \dim_use:N \l__Prassble_listings_autowidth_title_dim \ \rule{\l__Prassble_listings_autowidth_title_dim}{1pt}
                \item[\codeinline{TeX}{upper}:] \dim_use:N \l__Prassble_listings_autowidth_upper_dim \ \rule{\l__Prassble_listings_autowidth_upper_dim}{1pt}
                \item[\codeinline{TeX}{lower}:] \dim_use:N \l__Prassble_listings_autowidth_lower_dim \ \rule{\l__Prassble_listings_autowidth_lower_dim}{1pt}
              \end{enumerate}
          \item \codeinline{TeX}{\g__Prassble_listings_autowidth@core_measured_text_width_dim}:\ \dim_use:N \g__Prassble_listings_autowidth@core_measured_text_width_dim 
          \item \codeinline{TeX}{\g__Prassble_listings_autowidth@core_measured_width_dim}:\ \dim_use:N \g__Prassble_listings_autowidth@core_measured_width_dim
          \item \codeinline{TeX}{\g__Prassble_listings_autowidth@core_max_tcb_text_width_dim}:\ \dim_use:N \g__Prassble_listings_autowidth@core_max_tcb_text_width_dim
          \item \codeinline{TeX}{\g__Prassble_listings_autowidth@core_max_tcb_width_dim}:\  \dim_use:N \g__Prassble_listings_autowidth@core_max_tcb_width_dim
        \end{enumerate}
        \rule{\textwidth}{0.75pt}
        }
  }
  % Borderline west of \BorderlineWestThickness thickness
  \cs_new:Npn \__Prassble_listings_codestylecore@borderlinewest: {
    \tl_if_eq:NnT \ColorTheme {colourful} {
      \fill[\ColorCodeBorderline] (frame.south~west)
      rectangle ([xshift=\BorderlineWestThickness]frame.north~west);
    }
  }
  \bool_new:N \g__Prassble_listings_autowidth_title_bool
  \bool_new:N \g__Prassble_listings_autowidth_upper_bool
  \bool_new:N \g__Prassble_listings_autowidth_lower_bool
  \bool_new:N \g__Prassble_listings_debug_autowidth_bool
  \bool_new:N \g__Prassble_listings_include_codeoutput_bool
  \bool_new:N \g__Prassble_listings_include_comment_bool
  \bool_new:N \g__Prassble_listings_Input_bool
  % Values
  \tl_set:Nn \g__Prassble_listings_linenos_tl {linenos}
  \tl_set:Nn \g__Prassble_listings_breaklines_tl {breaklines}

\tcbset{
  ,before~add/.code = {
    \tl_put_right:Nn \g__Prassble_before_add_tl { #1~ }
    \pgfkeysalso{before = \g__Prassble_before_add_tl}
  }
  ,after~add/.code = {
    \tl_put_right:Nn \g__Prassble_after_add_tl { #1~ }
    \pgfkeysalso{after = \g__Prassble_after_add_tl}
  }
  ,no~number/.code = {\tl_clear:N \g__Prassble_listings_linenos_tl}
  ,minted~add/.code = {\tl_set:Nn \g__Prassble_listings_minted_add_tl {#1}}
  ,autowidth@core/.code = 
  {
    % Center the box
      \pgfkeysalso{center}

    \bool_if:NT \g__Prassble_listings_autowidth_title_bool
    {
      \dim_set:Nn \l__Prassble_listings_autowidth_title_dim 
      {
        \eqboxwidth{codetitlewidth\arabic{code}}-\g__Prassble_listings_Leftupper_dim
      }
    }
    \bool_if:NT \g__Prassble_listings_autowidth_upper_bool
    {
      \dim_set:Nn \l__Prassble_listings_autowidth_upper_dim
      {
        \eqboxwidth{codeupperwidth\arabic{code}}
      }
    }
    \bool_if:NT \g__Prassble_listings_autowidth_lower_bool
    {
      \dim_set:Nn \l__Prassble_listings_autowidth_lower_dim
      {
        \eqboxwidth{codelowerwidth\arabic{code}}-\g__Prassble_listings_Leftupper_dim
      }
    }
    \dim_set:Nn \g__Prassble_listings_autowidth@core_measured_text_width_dim 
      {
        \dim_max:nn 
        {\l__Prassble_listings_autowidth_title_dim} 
        {
          \dim_max:nn
          {\l__Prassble_listings_autowidth_upper_dim}
          {\l__Prassble_listings_autowidth_lower_dim}
        }
      }
    \dim_set:Nn \g__Prassble_listings_autowidth@core_text_width_vs_width_difference_dim {\kvtcb@left@rule+\kvtcb@right@rule+\kvtcb@boxsep*2+\kvtcb@leftupper+\kvtcb@rightupper}
    \dim_set:Nn \g__Prassble_listings_autowidth@core_max_tcb_text_width_dim {\__tcb_width_to_text_width:n {\g__Prassble_listings_autowidth@core_max_tcb_width_dim}}
    \dim_set:Nn \g__Prassble_listings_autowidth@core_measured_width_dim {\__tcb_text_width_to_width:n {\g__Prassble_listings_autowidth@core_measured_text_width_dim}}
    % The default tcb text width the box should be set to have, in the first compilation where eqparbox is still calculating the required widths.  
    \dim_compare:nNnTF 
    {\eqboxwidth{codeupperwidth\arabic{code}}}
      =
    {0pt}
    {
      %* Potentially fragile code
      \dim_set:Nn \g__Prassble_listings_autowidth@core_text_width_dim {\g__Prassble_listings_autowidth@core_max_tcb_width_dim}
    }
    {
      \dim_set:Nn \g__Prassble_listings_autowidth@core_text_width_dim
      {
        \dim_min:nn 
          {\g__Prassble_listings_autowidth@core_max_tcb_text_width_dim} {\g__Prassble_listings_autowidth@core_measured_text_width_dim} 
      } 
    }
    \bool_if:nTF 
      {
        \g__Prassble_listings_autowidth_upper_bool || {\g__Prassble_listings_autowidth_lower_bool && ! \dim_compare_p:nNn {\eqboxwidth{codeupperwidth\arabic{code}}}>{\l__Prassble_listings_autowidth_lower_dim}}
      } 
      {
        % Autowidth = upper: Disable breaklines to allow \eqboxwidth{codeupperwidth\arabic{code}} to correctly measure the greatest line width. Enable breaklines if the line width overflows into the margins---autowidth ceases to work (the listing behaves as if autowidth wasn't used). (Why? I'm not sure; this is just the behavior I observed and wrote my code around.) 
        \dim_compare:nNnTF
          % Relationship to compare 
          {\g__Prassble_listings_autowidth@core_max_tcb_text_width_dim} 
          < 
          {\g__Prassble_listings_autowidth@core_measured_text_width_dim}
          % TF code execution
          {\tl_set:Nn \g__Prassble_listings_breaklines_tl {breaklines}}
          {\tl_clear:N \g__Prassble_listings_breaklines_tl }
      }
      {
        % Autowidth = title: the title might be smaller (in width) than the body (upper and lower parts). So, breaklines needs to be enabled to avoid overflowing contents. Why doesn't breaklines essentially disable autowidth in this case (unlike for autowidth = upper)? Breaklines is a minted key that affects only the minted environment---the upper part of the box. 
        % If autowidth = lower wants to set the text width to something smaller than \l__Prassble_listings_autowidth_upper_dim, then breaklines must be enabled. Why not just always have breaklines enabled? We may want autowidth = upper and lower. 
        \tl_set:Nn \g__Prassble_listings_breaklines_tl {breaklines}
      }
  % autowidth functionality: setting the tcbkey 'text width'
    \pgfkeysalso{text~width = \g__Prassble_listings_autowidth@core_text_width_dim}
  }
  ,autowidth/.is~choice
    ,autowidth/title/.code = 
    {
      \bool_set_true:N \g__Prassble_listings_autowidth_title_bool
      \pgfkeysalso{autowidth@core}
    } 
    ,autowidth/upper/.code = 
    {
      \bool_set_true:N \g__Prassble_listings_autowidth_upper_bool
      \pgfkeysalso{autowidth@core}
    }
    ,autowidth/lower/.code = 
    {
      \bool_set_true:N \g__Prassble_listings_autowidth_lower_bool
      \pgfkeysalso
      {
        ,autowidth@core
      }
    }
    ,autowidth/above/.style =
    {
      ,autowidth = title
      ,autowidth = upper
    }
    ,autowidth/body/.style =
    {
      ,autowidth = upper
      ,autowidth = lower
    }
    ,autowidth/all/.style =
    {
      ,autowidth = title
      ,autowidth = upper
      ,autowidth = lower
    }
  ,debug/.is~choice
    ,debug/autowidth/.code = 
    {
      \bool_set_true:N \g__Prassble_listings_debug_autowidth_bool
    } 
  ,text~only/.prefix~code = {
    \bool_set_true:N \g__Prassble_listings_include_codeoutput_bool
  }
  ,listing~and~text/.prefix~code = {
    \bool_set_true:N \g__Prassble_listings_include_codeoutput_bool
  }
  ,text~and~listing/.prefix~code = {
    \bool_set_true:N \g__Prassble_listings_include_codeoutput_bool
  }
  ,listing~only/.prefix~code = {
    \bool_set_false:N \g__Prassble_listings_include_codeoutput_bool
  }
  ,comment~only/.prefix~code = {
    \bool_set_true:N \g__Prassble_listings_include_comment_bool
  }
  ,listing~and~comment/.prefix~code = {
    \bool_set_true:N \g__Prassble_listings_include_comment_bool
  }
  ,comment~and~listing/.prefix~code = {
    \bool_set_true:N \g__Prassble_listings_include_comment_bool
  }
  ,use~comment/.style = {
    ,comment = {#1}
    ,listing~and~comment
  }
  ,Title/.style = 
  {
    title   = 
    {
      \sffamily\bfseries\color{\ColorCodeTitle}
        {
          \__Prassble_listings_autowidth_title:n {#1}
          \__Prassble_listings_title_contents:n {#1}
        }
      }
  }
  ,OTitle/.code = {
    \tl_if_empty:nF {#1} {\tl_set:Nn \g__Prassble_listings_OTitle_tl {~(#1)}}
  }
  ,Leftupper/.code = {
    \dim_set:Nn \g__Prassble_listings_Leftupper_dim {
      % Make the right edge of the eqsavebox --- which contain the line numbers --- just touch the decoration/line number background. 
        \numbersep - \boxsep + \BorderlineWestThickness
      % Make the left edge of the eqsavebox just touch the decoration/line number background. 
        + \eqboxwidth{code\arabic{code}}
      % Further move it to the center of the decoration/ line number background.
        + \linenumberpadding/2
    }
    \pgfkeysalso{
      leftupper = \g__Prassble_listings_Leftupper_dim
    }
  }
  ,Append~if~BnW/.code = {
    \tl_if_eq:NnT \ColorTheme {BnW} 
    {
      \pgfkeysalso{
        ,lefttitle        = 0pt
        ,leftlower        = 0pt
        ,lower~separated  = false
        ,opacityfill      = 0.0
      }
    }
  }
  ,ColorfulBorderlineWest/. code = {
    \tl_if_eq:NnT \ColorTheme {colourful}
    {
      \pgfkeysalso{
        ,borderline~west                 = {\BorderlineWestThickness}{0pt}{\ColorCodeBorderline}
      }
    }
  }
% Base listing style
    % Help sourced from https://tex.stackexchange.com/a/748148/383565
    % codestylebase = { <Unparenthesized Title> }
  ,codestylebase/.style =
  {
    ,Leftupper
    ,Append~if~BnW
    ,listing~engine                  = minted
    ,minted~style                    = staroffice
    ,minted~options                  = 
      {
      ,\g__Prassble_listings_breaklines_tl
      ,autogobble
      ,\g__Prassble_listings_linenos_tl
      ,numbersep = \numbersep
      ,\g__Prassble_listings_minted_add_tl
      }
    ,listing~only
    ,breakable
    ,enhanced
    ,skin                            = enhanced~jigsaw
    ,boxsep                          = \boxsep
    ,boxrule                         = \boxrule
    ,colback                         = \ColorCodeColback 
    ,Title                           = {#1}
    ,toptitle                        = 2mm
    ,bottomtitle                     = 2mm
    ,colbacktitle                    = \ColorCodeColbacktitle,
    ,after~lower                            = \__Prassble_listings_autowidth_lower_savewidth: 
    ,ColorfulBorderlineWest
    ,overlay~unbroken                = {
      % Background for the code line numbers
        % Case 1: The current (partial) box contains only an upper part.
        \int_compare:nNnT {\tcbsegmentstate}={0} {
          \filldraw[\ColorCodeLineNumberBackground] 
            ([xshift=\BorderlineWestThickness]frame.south~west) 
            -- ([xshift=\BorderlineWestThickness]interior.north~west) 
            {[rounded~corners=4] 
              -- ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0) 
              -- ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding+\BorderlineWestThickness]frame.south~west)
            } 
            -- cycle;
        }
        % Case 2: The current (partial) box contains an upper and a lower part. The segmentation node can be used for positioning.
        \int_compare:nNnT {\tcbsegmentstate}={1} {
          \filldraw[\ColorCodeLineNumberBackground] 
            ([xshift=\BorderlineWestThickness]segmentation.west) 
            -- ([xshift=\BorderlineWestThickness]interior.north~west) {[rounded~corners=4] 
              -- ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0) 
              -- ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding+\BorderlineWestThickness]segmentation.west)
            }
            -- cycle;
        }
      % Borderline west of \BorderlineWestThickness thickness
      \__Prassble_listings_codestylecore@borderlinewest:
    }
    ,overlay~first                   = {
      % Background for the code line numbers
      \filldraw[\ColorCodeLineNumberBackground] 
        ([xshift=\BorderlineWestThickness]frame.south~west) 
        -- ([xshift=\BorderlineWestThickness]interior.north~west) 
        {[rounded~corners=4] 
          -- ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0)
        } 
      -- ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding+\BorderlineWestThickness]frame.south~west) 
      -- cycle;
      % Borderline west of \BorderlineWestThickness thickness
      \__Prassble_listings_codestylecore@borderlinewest:
    }
    ,overlay~middle                  = {
      % Background for the code line numbers
      \fill[\ColorCodeLineNumberBackground] 
        ([xshift=\BorderlineWestThickness]frame.south~west)
          rectangle 
        ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding+\BorderlineWestThickness]frame.north~west);
      % Borderline west of \BorderlineWestThickness thickness
      \__Prassble_listings_codestylecore@borderlinewest:
    }
    ,overlay~last                    = {
      % Background for the code line numbers
        % Case 1: The current (partial) box contains only an upper part.
        \int_compare:nNnT {\tcbsegmentstate}={0} {
          \filldraw[\ColorCodeLineNumberBackground] 
            ([xshift=\BorderlineWestThickness]frame.south~west) 
            -- ([xshift=\BorderlineWestThickness]frame.north~west)
            -- ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0) 
            {[rounded~corners=4] 
              -- ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding+\BorderlineWestThickness]frame.south~west)
            } 
            -- cycle;
        }
        % Case 2: The current (partial) box contains an upper and a lower part. The segmentation node can be used for positioning.
        \int_compare:nNnT {\tcbsegmentstate}={1} {
          \filldraw[\ColorCodeLineNumberBackground] 
            ([xshift=\BorderlineWestThickness]segmentation.west) 
            -- ([xshift=\BorderlineWestThickness]frame.north~west) 
            -- ++(\eqboxwidth{code\arabic{code}}+\linenumberpadding,0) {[rounded~corners=4] 
              -- ([xshift=\eqboxwidth{code\arabic{code}}+\linenumberpadding+\BorderlineWestThickness]segmentation.west)
            } 
            -- cycle;
        }
      % Borderline west of \BorderlineWestThickness thickness
      \__Prassble_listings_codestylecore@borderlinewest:
    }
  }
% listing environment style
    % Help sourced from https://tex.stackexchange.com/a/748148/383565
    % codestlyenvironment = 
    % #1  { <displayed language name to be converted to minted language>}
    % #2  { <Unparentisized Title> }
  ,codestyleenvironment/.style~2~args =
  {
    ,code = {\__Prassble_listings_displayed_to_pygments:n{#1}}
    ,minted~language                 = {\l_Prassble_listings_pygments_name_tl}
    ,codestylebase                   = {#2}
  }
% input listing style
    % Help sourced from https://tex.stackexchange.com/a/748148/383565
    % codestyleinput = 
    % #1  { <Listing file> }
    % #2  { <Unparentisized Title> }
    % The starred variant doesn't set the 'listing file' first. This allows the Input-related keys (such as 'pwd') to work correctly --- the 'listing file' key seems to take use its first invocation, and cannot be overriden.
  ,codestyleinput*/.style~2~args =
  {
    ,code           = {\storefileextension{#1}
    \_Prassble_listings_file_extension_to_language:n { \fileextension }}
    ,minted~language = {\l_Prassble_listings_pygments_name_tl}
    ,codestylebase  = {#2}
  },
  ,codestyleinput/.style~2~args =
  {
    ,listing~file   = {#1}
    ,codestyleinput* = {#1}{#2}
  },
  % Input-related keys
  ,pwd/.code = { \bool_set_true:N \g__Prassble_listings_Input_bool }
  ,prepend~path~or~key/.code = { \tl_set:Nn \g__Prassble_listings_Input_prepended_path_or_keyword_tl {#1} }
  ,prepend/.style = {prepend~path~or~key = {#1}}
  ,key/.style = {prepend~path~or~key = {#1}}
  ,Inputify/.code = 
  {
    \seq_clear:N \l_tmpa_seq
    \seq_put_right:Ne \l_tmpa_seq {\g__Prassble_listings_Input_prepended_path_or_keyword_tl}
    \seq_map_inline:Nn \l_tmpa_seq {
      \__Prassble_Input@core:nnnn { \g__Prassble_listings_Input_bool } { ##1 } { #1 } { \tl_gset:Ne \inputPath } 
    }
  }
}
\ExplSyntaxOff
\makeatother

% Base listing style, continued
\renewcommand{\theFancyVerbLine}{%
                \eqmakebox[code\arabic{code}][c]{%
                    \textcolor{\ColorCodeLineNumber}{\scriptsize\arabic{FancyVerbLine}}%
                }%
            }
\renewcommand{\FancyVerbFormatLine}[1]{\eqsavebox{\codewidth}[codeupperwidth\arabic{code}]{#1}#1}