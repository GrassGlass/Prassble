%% The LaTeX project Prassble
%% nonlistings.tex: the styles (keytheoremstyles of the keytheorem package) used for nonlisting environments (e.g. the theorem environment)
%%
%% -------------------------------------------------------------------------------------------
%% Copyright (c) 2025 by Grass (GrassGlass) <shaohong00002 at gmail dot com>
%% -------------------------------------------------------------------------------------------
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `author-maintained'.
%%
%% This work consists of all files listed in README
%%
% Standard boxes
    % source for the tcolorbox indentation fix 
    % "before upper={\parindent15pt\noindent}":
    %  https://tex.stackexchange.com/a/200654/383565

\theoremstyle{definition}

\newkeytheoremstyle{greenbox}{
    headfont	            = {\sffamily\bfseries\color{ForestGreen!70!black}},
    bodyfont	            = {\normalfont},
    tcolorbox-no-titlebar	= {
        breakable,
        skin    = enhanced jigsaw,
        boxsep  = \boxsep,
        boxrule = \boxrule,
        colback = ForestGreen!5,
        borderline west ={\BorderlineWestThickness}{0pt}{ForestGreen},
        before upper={\parindent=\myparindent},
    }
}

\newkeytheoremstyle{bluebox}{
    headfont	            = {\sffamily\bfseries\color{NavyBlue!70!black}},
    bodyfont	            = {\normalfont},
    tcolorbox-no-titlebar	= {
        breakable,
        skin    = enhanced jigsaw,
        boxsep  = \boxsep,
        boxrule = \boxrule,
        colback = NavyBlue!5,
        borderline west ={\BorderlineWestThickness}{0pt}{NavyBlue},
        before upper={\parindent=\myparindent},
    }
}

\newkeytheoremstyle{purplebox}{
    headfont	            = {\sffamily\bfseries\color{Mulberry!70!black}},
    bodyfont	            = {\normalfont},
    tcolorbox-no-titlebar	= {
        breakable,
        skin    = enhanced jigsaw,
        boxsep  = \boxsep,
        boxrule = \boxrule,
        colback = Mulberry!5,
        borderline west ={\BorderlineWestThickness}{0pt}{Mulberry},
        before upper={\parindent=\myparindent},
    }
}

\newkeytheoremstyle{redbox}{
    headfont	            = {\sffamily\bfseries\color{RawSienna!70!black}},
    bodyfont	            = {\normalfont},
    tcolorbox-no-titlebar	= {
        breakable,
        skin    = enhanced jigsaw,
        boxsep  = \boxsep,
        boxrule = \boxrule,
        colback = RawSienna!5,
        borderline west ={\BorderlineWestThickness}{0pt}{RawSienna},
        before upper={\parindent=\myparindent},
    }
}

\newkeytheoremstyle{proofbox}{
    headfont	            = {\sffamily\bfseries\color{RawSienna!70!black}},
    bodyfont	            = {\normalfont},
    numbered	            = no,
    qed = \eeveeKawaii,
    tcolorbox-no-titlebar	= {
        breakable,
        skin    = enhanced jigsaw,
        boxsep  = \boxsep,
        boxrule = \boxrule,
        colback = RawSienna!1,
        borderline west ={\BorderlineWestThickness}{0pt}{RawSienna},
        before upper={\parindent=\myparindent},
    }
}

\ExplSyntaxOn
    % The command \modifiednewkeytheorem that saves the name of the environemnt into \g__Prassble_environments_used_in_HWs_clist
        % Declaring variables
        \clist_new:N \g__Prassble_environments_used_in_HWs_clist
    \NewDocumentCommand{\modifednewkeytheorem}{ m +O{} }
    {
        \clist_gput_right:Nn \g__Prassble_environments_used_in_HWs_clist {#1}
        \newkeytheorem{#1}[#2]
    } 
    % The command \AddToHWEnvList
    \NewDocumentCommand{\AddToHWEnvList}{ m }{
        \clist_gput_right:Nn \g__Prassble_environments_used_in_HWs_clist {#1}
    }
    % The command \StyleDependentValue{ name }{ clist of BoxStyles }{ clist of corresponding values for a key=value <key>} that defines a macro \<name><key>, such that '<key> = \<name><key>' automatically adapts to the current boxstyle.
        % Declaring variables
        \int_new:N \l__Prassble_StyleDependentValue_number_in_boxstyles_int
        \tl_new:N \g__Prassble_boxstyle_tl
        \clist_new:N \l__Prassble_StyleDependentValue_all_boxstyles_clist
        \clist_new:N \l__Prassble_StyleDependentValue_value_for_key_clist
        % Default values
        \tl_set:Nn \g__Prassble_boxstyle_tl {\g__Prassble_pagestyle_tl}
    \NewDocumentCommand{\StyleDependentValue}{ O{} m m m }{
        % Initalising the macro that is the value for the keytheorems key 'Parent = '
        \tl_new:c {#2#1}
        % Defining #2 and #3 semantically as a clist
        \clist_set:Nn \l__Prassble_StyleDependentValue_all_boxstyles_clist {#3}
        \clist_set:Nn \l__Prassble_StyleDependentValue_value_for_key_clist {#4}
        % Setting the value in "parent = <value>" for the current Pagestyle
        \int_zero:N \l__Prassble_StyleDependentValue_number_in_boxstyles_int
        \clist_map_inline:nn {#3} 
        {
            \int_incr:N \l__Prassble_StyleDependentValue_number_in_boxstyles_int
            \tl_if_eq:enT {\g__Prassble_boxstyle_tl} {##1} 
            {
                \tl_gset:ce {#2#1} 
                {
                    \clist_item:Nn \l__Prassble_StyleDependentValue_value_for_key_clist {\l__Prassble_StyleDependentValue_number_in_boxstyles_int}
                }
            }
        }
    }
\makeatletter
    % HW-In-Main Input keyword
    \KeywordForInput{HW-In-Main}{files/homework}
    [
        % Header for hw
        % This is a new hw subsection, so raise the hw count
            \stepcounter{HWNumber}
        % The header
            \HWInMainHeader
        % Redefinition of \the<environment> to distinguish environments (e.g. exercise) used in hw subsections vs the environments natively belonging to the lecture notes/reference text.
            \clist_map_inline:Nn \g__Prassble_environments_used_in_HWs_clist 
            {
                % Save the current counter value \the#1 for the environment #1 before the hw subsection
                \int_new:c {g__Prassble_HW_In_Main_inital_#1_value_int}
                \int_set_eq:cc {g__Prassble_HW_In_Main_inital_#1_value_int} {c@#1}
            }
            \clist_map_inline:Nn \g__Prassble_environments_used_in_HWs_clist 
            {
                % Reset \the#1 for the hw subsection
                \setcounter{#1}{0}
                % Save the current definition of the#1 (the typeset counter) and theH#1.
                \cs_set_eq:cc {g__Prassble_pagestyle_main_the#1} {the#1}
                \cs_set_eq:cc {g__Prassble_pagestyle_main_theH#1} {theH#1}
                % Redefine the#1 in our custom HW-in-Main style (again, this is to distinguish hw content from the contents of the main material).
                \cs_set:cpn {the#1} {H.\arabic{HWNumber}.\arabic{#1}}
                % Redefine theH#1 to ensure hyperref works correctly
                \cs_set_eq:cc {theH#1} {the#1}
            }
    ]
    [
        % Restore the main pagestyle now that the hw subsection has ended
        \clist_map_inline:Nn \g__Prassble_environments_used_in_HWs_clist
            {
            \cs_set_eq:cc {the#1} {g__Prassble_pagestyle_main_the#1}
            \cs_set_eq:cc {theH#1} {g__Prassble_pagestyle_main_theH#1}
            \expandafter\setcounter{#1}{\csname g__Prassble_HW_In_Main_inital_#1_value_int\endcsname}
            }
    ]
\makeatother
\ExplSyntaxOff