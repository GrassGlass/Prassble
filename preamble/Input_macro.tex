%% The LaTeX project Prassble
%% Input_macro.tex: an original command \Input for easy input of files.
%%
%% -------------------------------------------------------------------------------------------
%% Copyright (c) 2025 by Grass (GrassGlass) <shaohong00002 at gmail dot com>
%% -------------------------------------------------------------------------------------------
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%%
%% This work has the LPPL maintenance status `author-maintained'.
%%
%% This work consists of all files listed in README
%%
\ExplSyntaxOn
% Command \KeywordForInput{ <keyword> }{ <file path to prepend, corresponding to <keyword> > }[ <code to prepend to \Input> ][ <code to append to \Input> ]
  % Defines a new <keyword> for \Input 
\seq_new:N \g__preable_Input_keywords_seq
\NewDocumentCommand{\KeywordForInput}{ m m +O{} +O{} }{
  \seq_if_in:NeTF \g__preable_Input_keywords_seq {#1}
    {
      % Issue warning if <keyword> has already been defined
    }
    {
      \seq_gput_right:Nn \g__preable_Input_keywords_seq {#1}
      % Declaring the token lists to be used in 
        % <file path to prepend, corresponding to <keyword> >
        \tl_new:c {g__Prassble_Input_relative_path_to_prepend_#1_tl}
        \tl_gset:cn {g__Prassble_Input_relative_path_to_prepend_#1_tl} {#2}
        % <code to prepend to \Input>
        \tl_new:c {g_Prassble_Input_prepend_#1_tl} 
        \tl_gset:cn {g_Prassble_Input_prepend_#1_tl} {#3}
        % <code to append to \Input>
        \tl_new:c {g_Prassble_Input_append_#1_tl} 
        \tl_gset:cn {g_Prassble_Input_append_#1_tl} {#4}
    }
}
%
%
% Easy input of files; \Input{#2} is \input{#2} but with the file path taken relative to
  % 1. the directory preamble, if \Input is used before \begin{document}
  % 2. the parent directory of the folder preamble (which in this case is the directory Prassble), if \Input is used after \begin{document}
  % 3. \CurrentFilePath, if (at anywhere) the starred variant \Input* is used
% \Input[#1]{#2} has the optional argument #1, which can prepend a file path #1 (folder_1/folder_2/.../folder_n) to the file path #2. That is, \Input[#1]{#2} = \input{#1#2}. But, #1 can also be a 'keyword' that causes the corresponding file path (defined with \KeywordforInput) to be prepended (instead of #1 itself), as well as cause some code (stored in \g_Prassble_Input_prepend_#1_tl and \g_Prassble_Input_append_#1_tl) to be possibly executed.
%* TLDR: \Input[ <keyword / file path to prepend> ]{ <file path relative to directory 'preamble' or '../preamble'> }
\clist_new:N \l__Prassble_files_to_be_input_clist
\tl_new:N \g_Prassble_Input_prepend_tl
\tl_new:N \g_Prassble_Input_append_tl
\tl_new:N \g_file_directory_to_be_used_tl
\tl_new:N \g_Prassble_path_to_Prassble_tl
\tl_new:N \l__Prassble_relative_path_to_prepend_tl
% Set the directory to be the folder 'preamble' in the preamble.
  \tl_gset:Ne \g_Prassble_path_to_Prassble_tl {\CurrentFilePath}
  \tl_set_eq:NN \g_file_directory_to_be_used_tl \g_Prassble_path_to_Prassble_tl
% Set the directory to be '../preamble' in the document body.
  \AtEndPreamble{\tl_gset:Ne \g_file_directory_to_be_used_tl {\g_Prassble_path_to_Prassble_tl/../}}
\NewDocumentCommand{\Input}{ s O{} m }{
  % If the starred variant \Input* is used, go to the directory \CurrentFilePath.
    \bool_if:nT {#1} 
      {
        \tl_set:Nn \g_file_directory_to_be_used_tl {\CurrentFilePath}
      }
  % Test whether #2 is a keyword
    \seq_if_in:NeTF \g__preable_Input_keywords_seq {#2} 
      {
        % If so, set the corresponding 
            % path to prepend
            % code to prepend
            % code to append
        \tl_set_eq:Nc \l__Prassble_relative_path_to_prepend_tl {g__Prassble_Input_relative_path_to_prepend_#2_tl}
        \tl_set_eq:Nc \g_Prassble_Input_prepend_tl {g_Prassble_Input_prepend_#2_tl}
        \tl_set_eq:Nc \g_Prassble_Input_append_tl {g_Prassble_Input_append_#2_tl}
      } 
      {
        % Otherwise, #2 is a file path that is to prepended as-is
        \tl_set:Nn \l__Prassble_relative_path_to_prepend_tl {#2}
      }
    % \input the files approperiately
    \clist_set:Nn \l__Prassble_files_to_be_input_clist {#3} 
    \clist_map_inline:Nn \l__Prassble_files_to_be_input_clist 
        {
            \tl_use:N \g_Prassble_Input_prepend_tl
            \input{\g_file_directory_to_be_used_tl/\l__Prassble_relative_path_to_prepend_tl/##1}
            \tl_use:N \g_Prassble_Input_append_tl
        }
  % Reset the path to prepend
    \tl_clear:N \l__Prassble_relative_path_to_prepend_tl
}
\ExplSyntaxOff